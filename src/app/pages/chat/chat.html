<div class="chat-layout">
  <!-- Overlay for mobile when sidebar is open -->
  @if (showSidebar() && isMobile()) {
    <div class="sidebar-overlay" (click)="toggleSidebar()"></div>
  }

  <!-- Sidebar with room list and user list -->
  <aside class="sidebar" [class.sidebar-visible]="showSidebar()" [class.sidebar-hidden]="!showSidebar()">
    <div class="sidebar-header">
      <h2>HappyTalk</h2>
      <button class="sidebar-close-btn" (click)="toggleSidebar()" aria-label="Close sidebar">
        Ã—
      </button>
    </div>

    <!-- Navigation Links -->
    <nav class="sidebar-navigation">
      <a routerLink="/contacts" routerLinkActive="active" class="nav-link" (click)="closeSidebarOnMobile()">
        <span class="nav-icon">ğŸ‘¥</span>
        <span class="nav-label">Contacts</span>
      </a>
      <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-link" (click)="closeSidebarOnMobile()">
        <span class="nav-icon">ğŸ’¬</span>
        <span class="nav-label">Chat</span>
      </a>
      <a routerLink="/profile" routerLinkActive="active" class="nav-link" (click)="closeSidebarOnMobile()">
        <span class="nav-icon">ğŸ‘¤</span>
        <span class="nav-label">Profile</span>
      </a>
    </nav>

    <div class="room-list-section">
      <app-room-list (roomSelected)="onRoomSelected($event)"></app-room-list>
    </div>

    <div class="user-list-section">
      <app-user-list (userSelected)="onUserSelected($event)"></app-user-list>
    </div>

    <div class="sidebar-footer">
      <a routerLink="/profile" class="current-user-info clickable" (click)="closeSidebarOnMobile()">
        <div class="user-avatar-small">
          {{ (currentUser()?.displayName || currentUser()?.username || 'U').substring(0, 2).toUpperCase() }}
        </div>
        <div class="user-details">
          <div class="user-name-small">{{ currentUser()?.displayName || 'User' }}</div>
          <div class="user-username-small">@{{ currentUser()?.username || 'unknown' }}</div>
        </div>
        <span class="profile-arrow">â€º</span>
      </a>
      <button 
        class="create-group-button" 
        (click)="openCreateGroupDialog()" 
        title="Create a new group">
        â• Create Group
      </button>
      <button class="logout-button" (click)="onLogout()" title="Logout">
        Logout
      </button>
    </div>
  </aside>

  <!-- Create Group Component (Hidden until opened) -->
  <app-create-group #createGroup></app-create-group>

  <!-- Main chat area -->
  <div class="chat-container" role="main">
    <header class="chat-header">
      <button class="menu-button" (click)="toggleSidebar()" aria-label="Toggle sidebar">
        â˜°
      </button>
      <h1>
        @if (currentView() === 'room' && currentRoom()) {
          <span class="emoji" aria-hidden="true">
            @if (currentRoom()!.id === 'public') {
              ğŸŒ
            } @else {
              #
            }
          </span>
          {{ currentRoom()!.name }}
        } @else if (currentView() === 'dm' && currentDMUser()) {
          <span class="emoji" aria-hidden="true">ğŸ’¬</span>
          Chat with {{ currentDMUser()?.displayName }}
        }
      </h1>
      <div class="connection-status" [class.connected]="connected()" [class.error]="connectionError()">
        @if (isConnecting()) {
          <span class="status-indicator connecting"></span>
          Connecting...
        } @else if (connected()) {
          <span class="status-indicator online"></span>
          Connected
        } @else if (connectionError()) {
          <span class="status-indicator offline"></span>
          {{ connectionError() }}
        } @else {
          <span class="status-indicator offline"></span>
          Disconnected
        }
      </div>
    </header>

    <div
    #messagesContainer
    class="messages-container" 
    role="log" 
    aria-live="polite" 
    aria-label="Chat messages"
    (scroll)="onScroll($event)">
    @if (messages().length === 0 && connected()) {
      <div class="empty-state">
        <span class="emoji" aria-hidden="true">ğŸ‘‹</span>
        <p>No messages yet. Be the first to say hello!</p>
      </div>
    }
    @for (message of messages(); track message.id) {
      <div 
        class="message-wrapper"
        [class.user-message]="message.sender === 'user'"
        [class.other-message]="message.sender === 'other'">
        <div class="message" [class.editing]="isEditingMessage(message.id)">
          @if (message.senderName) {
            <div class="message-sender">{{ message.senderName }}</div>
          }

          <!-- Message Content or Edit Form -->
          @if (isEditingMessage(message.id)) {
            <div class="message-edit-form">
              <textarea
                [value]="editingMessageText()"
                (input)="editingMessageText.set($any($event.target).value)"
                (keydown)="onEditKeydown($event, message)"
                class="message-edit-input"
                rows="3"
                placeholder="Edit message..."
                autofocus></textarea>
              <div class="message-edit-actions">
                <button 
                  type="button"
                  (click)="saveEditMessage(message)"
                  class="btn-save-edit"
                  [disabled]="isSavingEdit()">
                  @if (isSavingEdit()) {
                    Saving...
                  } @else {
                    âœ“ Save
                  }
                </button>
                <button 
                  type="button"
                  (click)="cancelEditMessage()"
                  class="btn-cancel-edit"
                  [disabled]="isSavingEdit()">
                  âœ— Cancel
                </button>
              </div>
            </div>
          } @else {
            <div class="message-content-wrapper">
              <div class="message-content">
                {{ message.text }}
              </div>

              <!-- Edited Badge -->
              @if (message.isEdited) {
                <span class="edited-badge" title="Edited at {{ message.editedAt | date: 'short' }}">
                  (Edited)
                </span>
              }

              <!-- Admin Controls -->
              @if (isSuperAdmin) {
                <div class="admin-controls">
                  <button 
                    type="button"
                    (click)="startEditMessage(message)"
                    class="btn-admin-action btn-edit"
                    title="Edit message"
                    aria-label="Edit message">
                    âœï¸
                  </button>
                  <button 
                    type="button"
                    (click)="deleteMessage(message)"
                    class="btn-admin-action btn-delete"
                    title="Delete message"
                    aria-label="Delete message"
                    [disabled]="isDeletingMessage()">
                    ğŸ—‘ï¸
                  </button>
                </div>
              }
            </div>
          }

          <div class="message-time">
            {{ message.timestamp | date: 'short' }}
          </div>
        </div>
      </div>
    }
  </div>

  <form class="message-input-container" (ngSubmit)="sendMessage()" (submit)="$event.preventDefault(); sendMessage()">
    <label for="message-input" class="visually-hidden">Type your message</label>
    <input
      id="message-input"
      type="text"
      [(ngModel)]="newMessage"
      (keypress)="onKeyPress($event)"
      placeholder="Type your message..."
      class="message-input"
      name="message"
      autocomplete="off"
      autocorrect="off"
      autocapitalize="sentences"
      spellcheck="true"
      aria-label="Message input"
      maxlength="500"
      [disabled]="!connected()"
      enterkeyhint="send"
    />
    <button 
      type="submit" 
      class="send-button"
      [disabled]="!newMessage.trim() || !connected()"
      aria-label="Send message"
      (click)="sendMessage()">
      <span aria-hidden="true">ğŸ“¤</span>
      Send
    </button>
  </form>
  </div>

  <!-- Confirmation dialog for message deletion -->
  @if (showDeleteConfirmation()) {
    <app-confirmation-dialog
      title="Delete Message"
      [message]="deleteConfirmationMessage()"
      confirmText="Delete"
      cancelText="Cancel"
      confirmButtonClass="danger"
      (confirmed)="confirmDeleteMessage()"
      (cancelled)="cancelDeleteMessage()"
    ></app-confirmation-dialog>
  }
</div>
