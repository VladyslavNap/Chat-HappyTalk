<div class="chat-layout">
  <!-- Sidebar with room list and user list -->
  @if (showSidebar()) {
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>HappyTalk</h2>
      </div>

      <div class="room-list-section">
        <app-room-list (roomSelected)="onRoomSelected($event)"></app-room-list>
      </div>

      <div class="user-list-section">
        <app-user-list (userSelected)="onUserSelected($event)"></app-user-list>
      </div>

      <div class="sidebar-footer">
        <div class="current-user-info">
          <div class="user-avatar-small">
            {{ (currentUser()?.displayName || currentUser()?.username || 'U').substring(0, 2).toUpperCase() }}
          </div>
          <div class="user-details">
            <div class="user-name-small">{{ currentUser()?.displayName || 'User' }}</div>
            <div class="user-username-small">@{{ currentUser()?.username || 'unknown' }}</div>
          </div>
        </div>
        <button class="logout-button" (click)="onLogout()" title="Logout">
          Logout
        </button>
      </div>
    </aside>
  }

  <!-- Main chat area -->
  <div class="chat-container" role="main">
    <header class="chat-header">
      <button class="menu-button" (click)="toggleSidebar()" aria-label="Toggle sidebar">
        â˜°
      </button>
      <h1>
        @if (currentView() === 'room' && currentRoom()) {
          <span class="emoji" aria-hidden="true">
            @if (currentRoom()!.id === 'public') {
              ğŸŒ
            } @else {
              #
            }
          </span>
          {{ currentRoom()!.name }}
        } @else if (currentView() === 'dm' && currentDMUser()) {
          <span class="emoji" aria-hidden="true">ğŸ’¬</span>
          Chat with {{ currentDMUser()?.displayName }}
        }
      </h1>
      <div class="connection-status" [class.connected]="connected()" [class.error]="connectionError()">
        @if (isConnecting()) {
          <span class="status-indicator connecting"></span>
          Connecting...
        } @else if (connected()) {
          <span class="status-indicator online"></span>
          Connected
        } @else if (connectionError()) {
          <span class="status-indicator offline"></span>
          {{ connectionError() }}
        } @else {
          <span class="status-indicator offline"></span>
          Disconnected
        }
      </div>
    </header>

    <div
    #messagesContainer
    class="messages-container" 
    role="log" 
    aria-live="polite" 
    aria-label="Chat messages"
    (scroll)="onScroll($event)">
    @if (messages().length === 0 && connected()) {
      <div class="empty-state">
        <span class="emoji" aria-hidden="true">ğŸ‘‹</span>
        <p>No messages yet. Be the first to say hello!</p>
      </div>
    }
    @for (message of messages(); track $index) {
      <div 
        class="message-wrapper"
        [class.user-message]="message.sender === 'user'"
        [class.other-message]="message.sender === 'other'">
        <div class="message">
          @if (message.senderName) {
            <div class="message-sender">{{ message.senderName }}</div>
          }
          <div class="message-content">
            {{ message.text }}
          </div>
          <div class="message-time">
            {{ message.timestamp | date: 'short' }}
          </div>
        </div>
      </div>
    }
  </div>

  <form class="message-input-container" (ngSubmit)="sendMessage()">
    <label for="message-input" class="visually-hidden">Type your message</label>
    <input
      id="message-input"
      type="text"
      [(ngModel)]="newMessage"
      (keypress)="onKeyPress($event)"
      placeholder="Type your message..."
      class="message-input"
      name="message"
      autocomplete="off"
      aria-label="Message input"
      maxlength="500"
      [disabled]="!connected()"
    />
    <button 
      type="submit" 
      class="send-button"
      [disabled]="!newMessage.trim() || !connected()"
      aria-label="Send message">
      <span aria-hidden="true">ğŸ“¤</span>
      Send
    </button>
  </form>
  </div>
</div>
