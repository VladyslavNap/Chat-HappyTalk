<div class="chat-layout">
  <!-- Overlay for mobile when sidebar is open -->
  @if (showSidebar() && isMobile()) {
    <div class="sidebar-overlay" (click)="toggleSidebar()"></div>
  }

  <!-- Sidebar with improved layout -->
  <aside class="sidebar" [class.sidebar-visible]="showSidebar()" [class.sidebar-hidden]="!showSidebar()">
    <!-- Header with app branding and close button -->
    <header class="sidebar-header">
      <div class="app-branding">
        <div class="app-logo">ğŸ’¬</div>
        <h1 class="app-title">HappyTalk</h1>
      </div>
      <button class="sidebar-close-btn" (click)="toggleSidebar()" aria-label="Close sidebar">
        âœ•
      </button>
    </header>

    <!-- Accordion Sections -->
    <div class="accordion-sections">
      <!-- Rooms Accordion Item -->
      <div class="accordion-item" [class.expanded]="expandedSections().has('rooms')">
        <div class="accordion-header" (click)="toggleAccordion('rooms')">
          <h2 class="accordion-title">
            <span class="accordion-icon">ğŸ </span>
            Rooms
          </h2>
          <div class="accordion-controls">
            <button class="section-action-btn" (click)="openCreateGroupDialog(); $event.stopPropagation()" title="Create new group">
              â•
            </button>
            <span class="accordion-chevron" [class.rotated]="expandedSections().has('rooms')">
              â–¼
            </span>
          </div>
        </div>
        <div class="accordion-content" [class.expanded]="expandedSections().has('rooms')">
          <div class="section-content">
            <app-room-list (roomSelected)="onRoomSelected($event)"></app-room-list>
          </div>
        </div>
      </div>

      <!-- Contacts Accordion Item -->
      <div class="accordion-item" [class.expanded]="expandedSections().has('contacts')">
        <div class="accordion-header" (click)="toggleAccordion('contacts')">
          <h2 class="accordion-title">
            <span class="accordion-icon">ğŸ‘¥</span>
            Contacts
            <span class="contact-count">{{ totalContactsCount() }}</span>
          </h2>
          <div class="accordion-controls">
            <button class="section-action-btn refresh-btn" (click)="refreshOnlineUsers(); $event.stopPropagation()" title="Refresh users">
              <span [class.spinning]="isRefreshing()">â†»</span>
            </button>
            <span class="accordion-chevron" [class.rotated]="expandedSections().has('contacts')">
              â–¼
            </span>
          </div>
        </div>
        <div class="accordion-content" [class.expanded]="expandedSections().has('contacts')">
          <div class="contact-sections">
            <!-- Online Contacts -->
            <div class="contact-subsection">
              <div class="subsection-header">
                <h3 class="subsection-title">
                  <span class="status-indicator online"></span>
                  Online
                  <span class="online-count">{{ onlineUsersCount() }}</span>
                </h3>
              </div>
              <div class="subsection-content">
                <app-user-list (userSelected)="onUserSelected($event)"></app-user-list>
              </div>
            </div>
            
            <!-- Offline Contacts -->
            <div class="contact-subsection">
              <div class="subsection-header">
                <h3 class="subsection-title">
                  <span class="status-indicator offline"></span>
                  Offline
                  <span class="offline-count">{{ offlineUsersCount() }}</span>
                </h3>
              </div>
              <div class="subsection-content">
                <app-offline-user-list [offlineUsers]="offlineUsersData()" (userSelected)="onUserSelected($event)"></app-offline-user-list>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- User Profile & Actions -->
    <footer class="sidebar-footer">
      <div class="user-profile">
        <div class="user-avatar">
          {{ (currentUser()?.displayName || currentUser()?.username || 'U').substring(0, 2).toUpperCase() }}
        </div>
        <div class="user-info">
          <div class="user-name">{{ currentUser()?.displayName || 'User' }}</div>
          <div class="user-status">ğŸŸ¢ Online</div>
        </div>
        <button class="user-menu-btn" (click)="toggleUserMenu()" aria-label="User menu">
          â‹¯
        </button>
      </div>
      
      <!-- Quick Actions -->
      <div class="quick-actions" [class.expanded]="showUserMenu()">
        <button class="action-btn secondary" (click)="openSettings()">
          <span class="btn-icon">âš™ï¸</span>
          Settings
        </button>
        <button class="action-btn secondary" (click)="openCreateGroupDialog()">
          <span class="btn-icon">â•</span>
          Create Group
        </button>
        <button class="action-btn danger" (click)="onLogout()">
          <span class="btn-icon">ğŸšª</span>
          Logout
        </button>
      </div>
    </footer>
  </aside>

  <!-- Right Side Menu -->
  <app-right-menu></app-right-menu>

  <!-- Create Group Component (Hidden until opened) -->
  <app-create-group #createGroup></app-create-group>

  <!-- Main chat area -->
  <div class="chat-container" role="main">
    <header class="chat-header">
      <button class="menu-button" (click)="toggleSidebar()" aria-label="Toggle sidebar">
        â˜°
      </button>
      <h1>
        @if (currentView() === 'room' && currentRoom()) {
          <span class="emoji" aria-hidden="true">
            @if (currentRoom()!.id === 'public') {
              ğŸŒ
            } @else {
              #
            }
          </span>
          {{ currentRoom()!.name }}
        } @else if (currentView() === 'dm' && currentDMUser()) {
          <span class="emoji" aria-hidden="true">ğŸ’¬</span>
          Chat with {{ currentDMUser()?.displayName }}
        }
      </h1>
      <div class="connection-status" [class.connected]="connected()" [class.error]="connectionError()">
        @if (isConnecting()) {
          <span class="status-indicator connecting"></span>
          Connecting...
        } @else if (connected()) {
          <span class="status-indicator online"></span>
          Connected
        } @else if (connectionError()) {
          <span class="status-indicator offline"></span>
          {{ connectionError() }}
        } @else {
          <span class="status-indicator offline"></span>
          Disconnected
        }
      </div>
    </header>

    <div
    #messagesContainer
    class="messages-container" 
    role="log" 
    aria-live="polite" 
    aria-label="Chat messages"
    (scroll)="onScroll($event)">
    @if (messages().length === 0 && connected()) {
      <div class="empty-state">
        <span class="emoji" aria-hidden="true">ğŸ‘‹</span>
        <p>No messages yet. Be the first to say hello!</p>
      </div>
    }
    @for (message of messages(); track message.id) {
      <div 
        class="message-wrapper"
        [class.user-message]="message.sender === 'user'"
        [class.other-message]="message.sender === 'other'">
        <div class="message" [class.editing]="isEditingMessage(message.id)">
          @if (message.senderName) {
            <div class="message-sender">{{ message.senderName }}</div>
          }

          <!-- Message Content or Edit Form -->
          @if (isEditingMessage(message.id)) {
            <div class="message-edit-form">
              <textarea
                [value]="editingMessageText()"
                (input)="editingMessageText.set($any($event.target).value)"
                (keydown)="onEditKeydown($event, message)"
                class="message-edit-input"
                rows="3"
                placeholder="Edit message..."
                autofocus></textarea>
              <div class="message-edit-actions">
                <button 
                  type="button"
                  (click)="saveEditMessage(message)"
                  class="btn-save-edit"
                  [disabled]="isSavingEdit()">
                  @if (isSavingEdit()) {
                    Saving...
                  } @else {
                    âœ“ Save
                  }
                </button>
                <button 
                  type="button"
                  (click)="cancelEditMessage()"
                  class="btn-cancel-edit"
                  [disabled]="isSavingEdit()">
                  âœ— Cancel
                </button>
              </div>
            </div>
          } @else {
            <div class="message-content-wrapper">
              <div class="message-content">
                {{ message.text }}
              </div>

              <!-- Edited Badge -->
              @if (message.isEdited) {
                <span class="edited-badge" title="Edited at {{ message.editedAt | date: 'short' }}">
                  (Edited)
                </span>
              }

              <!-- Admin Controls -->
              @if (isSuperAdmin) {
                <div class="admin-controls">
                  <button 
                    type="button"
                    (click)="startEditMessage(message)"
                    class="btn-admin-action btn-edit"
                    title="Edit message"
                    aria-label="Edit message">
                    âœï¸
                  </button>
                  <button 
                    type="button"
                    (click)="deleteMessage(message)"
                    class="btn-admin-action btn-delete"
                    title="Delete message"
                    aria-label="Delete message"
                    [disabled]="isDeletingMessage()">
                    ğŸ—‘ï¸
                  </button>
                </div>
              }
            </div>
          }

          <div class="message-time">
            {{ message.timestamp | date: 'short' }}
          </div>
        </div>
      </div>
    }
  </div>

  <form class="message-input-container" (ngSubmit)="sendMessage()" (submit)="$event.preventDefault(); sendMessage()">
    <label for="message-input" class="visually-hidden">Type your message</label>
    <input
      id="message-input"
      type="text"
      [(ngModel)]="newMessage"
      (keypress)="onKeyPress($event)"
      placeholder="Type your message..."
      class="message-input"
      name="message"
      autocomplete="off"
      autocorrect="off"
      autocapitalize="sentences"
      spellcheck="true"
      aria-label="Message input"
      maxlength="500"
      [disabled]="!connected()"
      enterkeyhint="send"
    />
    <button 
      type="submit" 
      class="send-button"
      [disabled]="!newMessage.trim() || !connected()"
      aria-label="Send message"
      (click)="sendMessage()">
      <span aria-hidden="true">ğŸ“¤</span>
      Send
    </button>
  </form>
  </div>

  <!-- Confirmation dialog for message deletion -->
  @if (showDeleteConfirmation()) {
    <app-confirmation-dialog
      title="Delete Message"
      [message]="deleteConfirmationMessage()"
      confirmText="Delete"
      cancelText="Cancel"
      confirmButtonClass="danger"
      (confirmed)="confirmDeleteMessage()"
      (cancelled)="cancelDeleteMessage()"
    ></app-confirmation-dialog>
  }
</div>
